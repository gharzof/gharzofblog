{% extends 'base.html' %}
{% block title %}{{ post.title }}{% endblock %}

{% block keywords %}{{ post.title }}{% endblock %}
{% block ogtitle %}{{ post.title }}{% endblock %}
{% block description %}{{ post.content|striptags|truncatechars:160 }}{% endblock %}
{% block ogdescription %}{{ post.content|striptags|truncatechars:160 }}{% endblock %}
{% block ogimage %}{{ post.image }}{% endblock %}


{% block content %}
<div class="container py-5">

  <div class="row">
    <div class="col-lg-8 mx-auto">

      <h1 class="mb-3">{{ post.title }}</h1>

      <p class="text-muted small">
        {{ post.created_at|date:"d M, Y" }}
        {% if post.category %}
          | <a class="text-decoration-none" href="/?category={{ post.category.slug }}">{{ post.category.name }}</a>
        {% endif %}
      </p>

      {% if post.image %}
        <img src="{{ post.image }}" alt="{{ post.title }}" class="img-fluid rounded shadow-sm mb-4">
      {% endif %}

      <div class="ck-content">
        {{ post.content|safe }}
      </div>

      {% if post.tags.all %}
        <div class="mt-4">
          {% for tag in post.tags.all %}
            <a href="/?tag={{ tag.slug }}" class="btn btn-sm btn-outline-primary me-2 mb-2">#{{ tag.name }}</a>
          {% endfor %}
        </div>
      {% endif %}

      <div class="mt-4">
        <button class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#shareModal">
          <i class="bi bi-share-fill me-1"></i> Share
        </button>
      </div>

    </div>
  </div>

  <hr class="my-5">

  {% if related_posts %}
    <div class="row">
      <h4 class="mb-4">Related Posts</h4>
      {% for related in related_posts %}
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card h-100 border-0 shadow-sm">
            {% if related.image %}
              <img src="{{ related.image }}" class="card-img-top" alt="{{ related.title }}">
            {% endif %}
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">{{ related.title|truncatechars:50 }}</h5>
              <p class="text-muted small mb-2">{{ related.created_at|date:"d M Y" }}</p>
              <a href="{% url 'post_detail' related.slug %}" class="btn btn-outline-primary mt-auto">Read More</a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

</div>

<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="modal-title" id="shareModalLabel">Share this post</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="d-flex justify-content-center flex-wrap gap-2 mb-3">
        <a href="https://t.me/share/url?url={{ request.build_absolute_uri }}" target="_blank" class="btn btn-sm btn-info text-white">
          <i class="bi bi-telegram me-1"></i> Telegram
        </a>
        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" class="btn btn-sm btn-primary">
          <i class="bi bi-facebook me-1"></i> Facebook
        </a>
        <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri }}" target="_blank" class="btn btn-sm btn-secondary">
          <i class="bi bi-linkedin me-1"></i> LinkedIn
        </a>
        <button class="btn btn-sm btn-outline-dark" onclick="copyLink()">
          <i class="bi bi-clipboard me-1"></i> Copy Link
        </button>
      </div>

      <div class="text-center">
        <div id="qrcode" class="d-flex justify-content-center mt-3"></div>
        <p class="mt-2 text-muted small">Scan QR code to share</p>
      </div>

      <div class="text-center mt-3">
        <button type="button" class="btn btn-link" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<style>
  .ck-content img {
    max-width: 100%;
    height: auto;
    border-radius: 10px;
  }
  .ck-content {
    padding: 0 15px;
  }
</style>

<script>
  function copyLink() {
    navigator.clipboard.writeText(window.location.href).then(function () {
      alert("Link copied to clipboard!");
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    const shareModal = document.getElementById('shareModal');
    shareModal.addEventListener('show.bs.modal', function () {
      document.getElementById("qrcode").innerHTML = "";
      new QRCode(document.getElementById("qrcode"), {
        text: window.location.href,
        width: 160,
        height: 160,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
    });
  });
</script>
{% endblock %}
